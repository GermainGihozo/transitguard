<script>
const role = localStorage.getItem("role");

if (role !== "super_admin") {
  alert("Access denied. Admin only.");
  window.location.href = "login.html";
}
</script>
<!DOCTYPE html>
<html>
<head>
  <title>TransitGuard Control Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #0f172a;
      color: white;
    }

    .card {
      background: #1e293b;
      border: none;
      border-radius: 15px;
    }

    .stat-number {
      font-size: 30px;
      font-weight: bold;
    }

    table {
      color: white !important;
    }

    .approved {
      color: #22c55e;
      font-weight: bold;
    }

    .denied {
      color: #ef4444;
      font-weight: bold;
    }
  </style>
</head>

<body>

<script>
  const token = localStorage.getItem("token");

  if (!token) {
    alert("Access denied. Please login.");
    window.location.href = "login.html";
  }
</script>

<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üö¶ TransitGuard Control Panel</h2>
    <div>
      <a href="scan.html" class="btn btn-success">Scan Passenger</a>
      <button onclick="logout()" class="btn btn-danger">Logout</button>
    </div>
  </div>

  <!-- STATS -->
  <div class="row text-center mb-4">
    <div class="col-md-4">
      <div class="card p-3">
        <div>Total Scans Today</div>
        <div id="total" class="stat-number">0</div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-3">
        <div>Approved</div>
        <div id="approved" class="stat-number text-success">0</div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-3">
        <div>Denied</div>
        <div id="denied" class="stat-number text-danger">0</div>
      </div>
    </div>
  </div>
  <div class="card p-4 mt-4">
  <h5>üöç Active Trips Overview</h5>
  <div id="tripContainer" class="row mt-3"></div>
</div>

  <!-- LIVE TABLE -->
  <div class="card p-4">
    <h5>Recent Boarding Activity</h5>
    <table class="table table-dark table-hover mt-3">
      <thead>
        <tr>
          <th>Time</th>
          <th>Passenger</th>
          <th>Seat</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="records"></tbody>
    </table>
  </div>

</div>

<script>
async function loadDashboard() {
  try {
    const res = await fetch("http://localhost:5000/api/dashboard/live", {
      headers: {
        "Authorization": "Bearer " + token
      }
    });

    const data = await res.json();

    document.getElementById("total").innerText = data.stats.total_scans || 0;
    document.getElementById("approved").innerText = data.stats.approved || 0;
    document.getElementById("denied").innerText = data.stats.denied || 0;

    const tbody = document.getElementById("records");
    tbody.innerHTML = "";

    data.records.forEach(r => {
      tbody.innerHTML += `
        <tr>
          <td>${new Date(r.scan_time).toLocaleTimeString()}</td>
          <td>${r.full_name}</td>
          <td>${r.seat_number || "-"}</td>
          <td class="${r.status}">${r.status.toUpperCase()}</td>
        </tr>
      `;
    });

  } catch (err) {
    console.error("Dashboard error:", err);
  }
}

function logout() {
  localStorage.removeItem("token");
  window.location.href = "login.html";
}

// Initial load
loadDashboard();

// Auto refresh every 5 seconds
setInterval(loadDashboard, 5000);
</script>

</body>
</html>